{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-10">
    
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div class="lg:col-span-4 space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <i class="fa-solid fa-sliders text-indigo-600"></i> Configuration
                    </h2>
                    <button onclick="resetSession()" class="text-xs text-slate-400 hover:text-red-500 font-medium transition" title="Clear current session">
                        <i class="fa-solid fa-rotate-right"></i> Reset
                    </button>
                </div>
                
                <form id="generateForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Topic</label>
                        <input type="text" id="topic" required
                            class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"
                            placeholder="e.g. Rust vs Go for Web Dev">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Tone</label>
                            <select id="tone" class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="Professional">Professional</option>
                                <option value="Technical">Technical</option>
                                <option value="Casual">Casual</option>
                                <option value="Humorous">Humorous</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Audience</label>
                            <select id="audience" class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="Developers">Developers</option>
                                <option value="Beginners">Beginners</option>
                                <option value="Managers">Managers</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Word Limit</label>
                        <select id="length" class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                            <option value="Short (500+ words)">Short (500+ words)</option>
                            <option value="Medium (750+ words)" selected>Medium (750+ words)</option>
                            <option value="Long (1000+ words)">Long (1000+ words)</option>
                        </select>
                    </div>

                    <div class="flex items-center gap-2 pt-2">
                        <input type="checkbox" id="examples" checked class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                        <label for="examples" class="text-sm font-medium text-slate-700">Include Code Snippets</label>
                    </div>

                    <button type="submit" id="generateBtn" 
                        class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl transition shadow-md flex justify-center items-center gap-2">
                        <span>Start Agent Team</span>
                        <i class="fa-solid fa-play"></i>
                    </button>
                </form>
            </div>

            <div class="bg-slate-900 rounded-2xl p-4 shadow-lg border border-slate-700 h-96 flex flex-col">
                <div class="text-xs text-slate-500 font-bold uppercase tracking-wider mb-2 border-b border-slate-700 pb-2">System Logs</div>
                <div id="console" class="flex-grow overflow-y-auto font-mono text-xs space-y-1 text-slate-300 
                    [&::-webkit-scrollbar]:w-2 [&::-webkit-scrollbar-track]:bg-transparent [&::-webkit-scrollbar-thumb]:bg-slate-700 [&::-webkit-scrollbar-thumb]:rounded-full hover:[&::-webkit-scrollbar-thumb]:bg-slate-600">
                    <div class="text-emerald-500">> System ready.</div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-8 space-y-6">
            
            <div class="grid grid-cols-4 gap-3">
                <div id="card-research" class="bg-white p-3 rounded-xl border border-slate-200 opacity-50 transition-all duration-300">
                    <div class="text-xs text-slate-400 uppercase font-bold mb-1">Step 1</div>
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-magnifying-glass text-blue-500"></i><span class="font-bold text-slate-700 text-sm">Research</span>
                    </div>
                </div>
                <div id="card-outline" class="bg-white p-3 rounded-xl border border-slate-200 opacity-50 transition-all duration-300">
                    <div class="text-xs text-slate-400 uppercase font-bold mb-1">Step 2</div>
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-list-check text-purple-500"></i><span class="font-bold text-slate-700 text-sm">Outline</span>
                    </div>
                </div>
                <div id="card-writing" class="bg-white p-3 rounded-xl border border-slate-200 opacity-50 transition-all duration-300">
                    <div class="text-xs text-slate-400 uppercase font-bold mb-1">Step 3</div>
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-pen-nib text-amber-500"></i><span class="font-bold text-slate-700 text-sm">Drafting</span>
                    </div>
                </div>
                <div id="card-editing" class="bg-white p-3 rounded-xl border border-slate-200 opacity-50 transition-all duration-300">
                    <div class="text-xs text-slate-400 uppercase font-bold mb-1">Step 4</div>
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-wand-magic-sparkles text-emerald-500"></i><span class="font-bold text-slate-700 text-sm">Editing</span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 min-h-[500px] p-8 relative">
                <div id="initialState" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400">
                    <i class="fa-solid fa-robot text-4xl mb-4 opacity-20"></i>
                    <p>Enter a topic to wake the agents</p>
                </div>
                <div id="resultArea" class="hidden">
                    <div class="flex justify-between items-center border-b border-slate-100 pb-4 mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">Generated Content</h2>
                        <div class="flex gap-2">
                             <button onclick="resetSession()" class="text-slate-500 hover:bg-slate-100 px-3 py-1 rounded-lg text-sm font-medium transition border border-slate-200">+ New Blog</button>
                            <button onclick="copyContent()" class="text-indigo-600 hover:bg-indigo-50 px-3 py-1 rounded-lg text-sm font-medium transition border border-transparent"><i class="fa-regular fa-copy mr-1"></i> Copy</button>
                        </div>
                    </div>
                    <div id="blogContent" class="prose max-w-none"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const consoleDiv = document.getElementById('console');
    const generateBtn = document.getElementById('generateBtn');
    
    // Helpers (Log, UpdateCard, Highlight) - Same as before
    function log(msg, type='info') {
        const div = document.createElement('div');
        const time = new Date().toLocaleTimeString().split(' ')[0];
        div.className = type === 'error' ? 'text-red-400' : (type === 'success' ? 'text-emerald-400' : 'text-slate-400 italic');
        div.innerHTML = `<span class="opacity-30 mr-2">[${time}]</span> ${msg}`;
        consoleDiv.appendChild(div);
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
        saveState({ logs: consoleDiv.innerHTML });
    }

    function updateCard(stage, status) {
        const card = document.getElementById(`card-${stage}`);
        if (!card) return;
        if (status === 'active') {
            card.classList.remove('opacity-50');
            card.classList.add('ring-2', 'ring-indigo-500', 'scale-105');
            card.querySelector('.text-slate-400').innerText = 'Working...';
        } else if (status === 'complete') {
            card.classList.remove('ring-2', 'ring-indigo-500', 'scale-105');
            card.classList.add('bg-emerald-50', 'border-emerald-200');
            card.querySelector('.text-slate-400').innerText = 'Done';
            card.querySelector('.text-slate-400').classList.add('text-emerald-600');
        }
    }

    function enhanceCodeBlocks() {
        // SAFETY CHECK: Is highlight.js loaded?
        if (typeof hljs !== 'undefined') {
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        } else {
            console.warn("Highlight.js (hljs) not found. Skipping syntax highlighting.");
        }

        // Add Copy Buttons (Independent of hljs)
        document.querySelectorAll('pre').forEach((pre) => {
            if (pre.querySelector('.copy-code-btn')) return;
            const btn = document.createElement('button');
            btn.className = 'copy-code-btn';
            btn.innerHTML = '<i class="fa-regular fa-copy"></i>';
            
            btn.addEventListener('click', () => {
                const code = pre.querySelector('code').innerText;
                navigator.clipboard.writeText(code);
                btn.innerHTML = '<i class="fa-solid fa-check text-emerald-400"></i>';
                setTimeout(() => {
                    btn.innerHTML = '<i class="fa-regular fa-copy"></i>';
                }, 2000);
            });

            pre.appendChild(btn);
        });
    }

    // --- UPDATED SUBMIT HANDLER ---
    document.getElementById('generateForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Capture Inputs
        const topic = document.getElementById('topic').value;
        const tone = document.getElementById('tone').value;
        const audience = document.getElementById('audience').value;
        const length = document.getElementById('length').value; // New
        const include_examples = document.getElementById('examples').checked; // New

        // Save State
        saveState({ 
            topic, tone, audience, length, include_examples,
            status: 'processing', 
            logs: '<div class="text-emerald-500">> System ready.</div>' 
        });

        // Reset UI
        document.getElementById('console').innerHTML = '<div class="text-emerald-500">> System ready.</div>';
        document.getElementById('initialState').style.display = 'none';
        document.getElementById('resultArea').classList.add('hidden');
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Agents Working...';
        log(`Starting session for topic: "${topic}"`, 'system');

        try {
            const response = await fetch('/api/generate-blog', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    topic: topic,
                    preferences: { 
                        tone, 
                        audience,
                        length,           // Sent to backend
                        include_examples  // Sent to backend
                    }
                })
            });

            // ... (Stream Reading Logic remains same as previous version) ...
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, {stream: true});
                const parts = buffer.split('\n\n');
                buffer = parts.pop();
                for (const part of parts) {
                    const lines = part.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                await handleEvent(data);
                            } catch (e) { console.log('Ignore parse error'); }
                        }
                    }
                }
            }
        } catch (err) {
            log(`Connection Error: ${err}`, 'error');
            generateBtn.disabled = false;
            generateBtn.innerText = 'Start Agent Team';
        }
    });

    // ... (HandleEvent, StateManagement, ResetSession - same as previous) ...
    // Just ensure handleEvent calls enhanceCodeBlocks() on completion
    async function handleEvent(data) {
        switch(data.event) {
            case 'stage_start':
                log(`> Agent Activated: ${data.stage.toUpperCase()}`);
                updateCard(data.stage, 'active');
                break;
            case 'research_complete':
                log(`Research found ${data.data.key_points?.length || 0} key points.`, 'success');
                updateCard('research', 'complete');
                break;
            case 'outline_complete':
                const title = data.data.outline?.title || data.data.title || 'Untitled';
                log(`Outline generated: "${title}"`, 'success');
                updateCard('outline', 'complete');
                break;
            case 'writing_complete':
                log(`Drafting complete. Sending to editor...`, 'success');
                updateCard('writing', 'complete');
                break;
            case 'complete':
                log(`ðŸŽ‰ Workflow Complete! Fetching final content...`, 'success');
                updateCard('editing', 'complete');
                try {
                    const res = await fetch(`/api/session/${data.session_id}`);
                    const sessionData = await res.json();
                    let cleanText = sessionData.final_blog;
                    if (typeof cleanText === 'object') cleanText = cleanText.result || JSON.stringify(cleanText);
                    cleanText = cleanText.replace(/^```markdown\n/, '').replace(/```$/, '');
                    document.getElementById('blogContent').innerHTML = marked.parse(cleanText);
                    enhanceCodeBlocks(); // <--- syntax highlight
                    document.getElementById('resultArea').classList.remove('hidden');
                    saveState({ status: 'complete', finalContent: cleanText });
                } catch (e) { log(`Failed to load content: ${e}`, 'error'); }
                generateBtn.disabled = false;
                generateBtn.innerHTML = 'Regenerate';
                break;
            case 'error':
                log(`Error: ${data.error}`, 'error');
                break;
        }
    }

    function copyContent() {
        const text = document.getElementById('blogContent').innerText;
        navigator.clipboard.writeText(text);
        alert('Copied to clipboard!');
    }
    
    // ... (State Management functions restoreState/saveState/resetSession) ...
    function saveState(partialState) {
        const existing = JSON.parse(localStorage.getItem('lekhai_state') || '{}');
        const newState = { ...existing, ...partialState };
        localStorage.setItem('lekhai_state', JSON.stringify(newState));
    }

    function restoreState(state) {
        if (state.topic) document.getElementById('topic').value = state.topic;
        if (state.tone) document.getElementById('tone').value = state.tone;
        if (state.audience) document.getElementById('audience').value = state.audience;
        // Restore new fields
        if (state.length) document.getElementById('length').value = state.length;
        if (state.include_examples !== undefined) document.getElementById('examples').checked = state.include_examples;

        if (state.logs) {
            consoleDiv.innerHTML = state.logs;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        if (state.status === 'processing' || state.status === 'complete') {
            document.getElementById('initialState').style.display = 'none';
        }
        if (state.status === 'processing') {
             generateBtn.disabled = true;
             generateBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Agents Working...';
        }
        if (state.finalContent) {
            document.getElementById('resultArea').classList.remove('hidden');
            document.getElementById('blogContent').innerHTML = marked.parse(state.finalContent);
            enhanceCodeBlocks();
            updateCard('research', 'complete');
            updateCard('outline', 'complete');
            updateCard('writing', 'complete');
            updateCard('editing', 'complete');
            generateBtn.innerHTML = 'Regenerate';
        }
    }
    function resetSession() {
        localStorage.removeItem('lekhai_state');
        window.location.reload();
    }
    
    window.addEventListener('load', () => {
        const savedState = localStorage.getItem('lekhai_state');
        if (savedState) restoreState(JSON.parse(savedState));
    });
</script>
{% endblock %}
{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-10">
    
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div class="lg:col-span-4 space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-sliders text-indigo-600"></i> Configuration
                </h2>
                
                <form id="generateForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Topic</label>
                        <input type="text" id="topic" required
                            class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"
                            placeholder="e.g. Rust vs Go for Web Dev">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Tone</label>
                            <select id="tone" class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm">
                                <option value="professional">Professional</option>
                                <option value="technical">Technical</option>
                                <option value="casual">Casual</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Audience</label>
                            <select id="audience" class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm">
                                <option value="developers">Developers</option>
                                <option value="beginners">Beginners</option>
                                <option value="managers">Managers</option>
                            </select>
                        </div>
                    </div>

                    <button type="submit" id="generateBtn" 
                        class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl transition shadow-md flex justify-center items-center gap-2">
                        <span>Start Agent Team</span>
                        <i class="fa-solid fa-play"></i>
                    </button>
                </form>
            </div>

            <div class="bg-slate-900 rounded-2xl p-4 shadow-lg border border-slate-700 h-64 flex flex-col">
                <div class="text-xs text-slate-500 font-bold uppercase tracking-wider mb-2 border-b border-slate-700 pb-2">System Logs</div>
                <div id="console" class="flex-grow overflow-y-auto font-mono text-xs space-y-1 text-slate-300">
                    <div class="text-emerald-500">> System ready.</div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-8 space-y-6">
            
            <div class="grid grid-cols-4 gap-3">
                <div id="card-research" class="bg-white p-3 rounded-xl border border-slate-200 opacity-50 transition-all duration-300">
                    <div class="text-xs text-slate-400 uppercase font-bold mb-1">Step 1</div>
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-magnifying-glass text-blue-500"></i>
                        <span class="font-bold text-slate-700 text-sm">Research</span>
                    </div>
                </div>
                <div id="card-outline" class="bg-white p-3 rounded-xl border border-slate-200 opacity-50 transition-all duration-300">
                    <div class="text-xs text-slate-400 uppercase font-bold mb-1">Step 2</div>
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-list-check text-purple-500"></i>
                        <span class="font-bold text-slate-700 text-sm">Outline</span>
                    </div>
                </div>
                <div id="card-writing" class="bg-white p-3 rounded-xl border border-slate-200 opacity-50 transition-all duration-300">
                    <div class="text-xs text-slate-400 uppercase font-bold mb-1">Step 3</div>
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-pen-nib text-amber-500"></i>
                        <span class="font-bold text-slate-700 text-sm">Drafting</span>
                    </div>
                </div>
                <div id="card-editing" class="bg-white p-3 rounded-xl border border-slate-200 opacity-50 transition-all duration-300">
                    <div class="text-xs text-slate-400 uppercase font-bold mb-1">Step 4</div>
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-wand-magic-sparkles text-emerald-500"></i>
                        <span class="font-bold text-slate-700 text-sm">Editing</span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 min-h-[500px] p-8 relative">
                
                <div id="initialState" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400">
                    <i class="fa-solid fa-robot text-4xl mb-4 opacity-20"></i>
                    <p>Enter a topic to wake the agents</p>
                </div>

                <div id="resultArea" class="hidden">
                    <div class="flex justify-between items-center border-b border-slate-100 pb-4 mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">Generated Content</h2>
                        <button onclick="copyContent()" class="text-indigo-600 hover:bg-indigo-50 px-3 py-1 rounded-lg text-sm font-medium transition">
                            <i class="fa-regular fa-copy mr-1"></i> Copy
                        </button>
                    </div>
                    <div id="blogContent" class="prose max-w-none"></div>
                </div>

            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const consoleDiv = document.getElementById('console');
    const generateBtn = document.getElementById('generateBtn');

    // Helper to log to the UI console
    function log(msg, type='info') {
        const div = document.createElement('div');
        const time = new Date().toLocaleTimeString().split(' ')[0];
        
        if (type === 'error') div.className = 'text-red-400';
        else if (type === 'success') div.className = 'text-emerald-400';
        else if (type === 'system') div.className = 'text-slate-400 italic';
        
        div.innerHTML = `<span class="opacity-30 mr-2">[${time}]</span> ${msg}`;
        consoleDiv.appendChild(div);
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }

    // Helper to update agent cards
    function updateCard(stage, status) {
        const card = document.getElementById(`card-${stage}`);
        if (!card) return;

        if (status === 'active') {
            card.classList.remove('opacity-50');
            card.classList.add('ring-2', 'ring-indigo-500', 'shadow-md', 'scale-105');
            card.querySelector('.text-slate-400').innerText = 'Working...';
        } else if (status === 'complete') {
            card.classList.remove('ring-2', 'ring-indigo-500', 'shadow-md', 'scale-105');
            card.classList.add('bg-emerald-50', 'border-emerald-200');
            card.querySelector('.text-slate-400').innerText = 'Done';
            card.querySelector('.text-slate-400').classList.add('text-emerald-600');
        }
    }

    document.getElementById('generateForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const topic = document.getElementById('topic').value;
        const tone = document.getElementById('tone').value;
        const audience = document.getElementById('audience').value;

        // Reset UI
        document.getElementById('initialState').style.display = 'none';
        document.getElementById('resultArea').classList.add('hidden');
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Agents Working...';
        log(`Starting session for topic: "${topic}"`, 'system');

        try {
            const response = await fetch('/api/generate-blog', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    topic: topic,
                    preferences: { tone, audience }
                })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            handleEvent(data);
                        } catch (e) { console.log('Parse error', e); }
                    }
                }
            }
        } catch (err) {
            log(`Connection Error: ${err}`, 'error');
            generateBtn.disabled = false;
            generateBtn.innerText = 'Start Agent Team';
        }
    });

    function handleEvent(data) {
        switch(data.event) {
            case 'stage_start':
                log(`> Agent Activated: ${data.stage.toUpperCase()}`);
                updateCard(data.stage, 'active');
                break;
            
            case 'research_complete':
                log(`Research found ${data.data.key_points?.length || 0} key points.`, 'success');
                updateCard('research', 'complete');
                break;

            case 'outline_complete':
                log(`Outline generated: "${data.data.outline?.title || 'Untitled'}"`, 'success');
                updateCard('outline', 'complete');
                break;

            case 'writing_complete':
                log(`Drafting complete. Sending to editor...`, 'success');
                updateCard('writing', 'complete');
                break;

            case 'complete':
                log(`ðŸŽ‰ Workflow Complete! Word count: ${data.metrics.word_count}`, 'success');
                updateCard('editing', 'complete');
                
                // Render Result
                const rawText = typeof data.final_blog_preview === 'string' 
                    ? data.final_blog_preview 
                    : JSON.stringify(data.final_blog_preview);
                
                // Clean markdown format
                const cleanText = rawText.replace(/^```markdown\n/, '').replace(/```$/, '');
                
                document.getElementById('blogContent').innerHTML = marked.parse(cleanText);
                document.getElementById('resultArea').classList.remove('hidden');
                
                generateBtn.disabled = false;
                generateBtn.innerHTML = 'Start New Session';
                break;
                
            case 'error':
                log(`Error: ${data.error}`, 'error');
                break;
        }
    }

    function copyContent() {
        const text = document.getElementById('blogContent').innerText;
        navigator.clipboard.writeText(text);
        alert('Copied to clipboard!');
    }
</script>
{% endblock %}